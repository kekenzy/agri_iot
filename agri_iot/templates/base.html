<!DOCTYPE html>
{% load static %}
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>{% block title %}Agri App{% endblock %}</title>
    {% load static %}
    {% load style_tags %}
    {% get_active_style as active_style %}
    
    <!-- å…±é€šã‚¹ã‚¿ã‚¤ãƒ« -->
    <link rel="stylesheet" href="{% static 'css/common-style.css' %}?v=2.2">
    
    <!-- ãƒ†ãƒ¼ãƒå›ºæœ‰ã‚¹ã‚¿ã‚¤ãƒ« -->
    {% if active_style == 'dark' %}
        <link rel="stylesheet" href="{% static 'css/dark-style.css' %}?v=2.2">
    {% elif active_style == 'colorful' %}
        <link rel="stylesheet" href="{% static 'css/colorful-style.css' %}?v=2.2">
    {% elif active_style == 'kuuma' %}
        <link rel="stylesheet" href="{% static 'css/kuuma-style.css' %}?v=2.2">
    {% else %}
        <link rel="stylesheet" href="{% static 'css/base-style.css' %}?v=2.2">
    {% endif %}
  </head>
  <body>
    <nav class="navbar">
      <div class="container">
        <div class="nav-content">
          <div class="nav-left">
            {% if user.is_authenticated %}
              {% if user.is_superuser %}
                <!-- ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼: å…¨ã¦ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤º -->
                <a class="nav-link" href="{% url 'admin:index' %}">ç®¡ç†ç”»é¢</a>
                <a class="nav-link" href="{% url 'agri_app:home' %}">ãƒ›ãƒ¼ãƒ </a>
                <a class="nav-link" href="{% url 'agri_app:s3_file_list' %}">å†™çœŸä¸€è¦§</a>
                <a class="nav-link" href="{% url 'agri_app:user_list' %}">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</a>
                <a class="nav-link" href="{% url 'agri_app:group_list' %}">ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†</a>
              {% elif user.is_staff %}
                <!-- ç®¡ç†è€…: ç®¡ç†ç”»é¢ä»¥å¤–ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤º -->
                <a class="nav-link" href="{% url 'agri_app:home' %}">ãƒ›ãƒ¼ãƒ </a>
                <a class="nav-link" href="{% url 'agri_app:s3_file_list' %}">å†™çœŸä¸€è¦§</a>
                <a class="nav-link" href="{% url 'agri_app:user_list' %}">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</a>
                <a class="nav-link" href="{% url 'agri_app:group_list' %}">ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†</a>
              {% else %}
                <!-- ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼: ãƒ›ãƒ¼ãƒ ã¨å†™çœŸä¸€è¦§ã®ã¿è¡¨ç¤º -->
                <a class="nav-link" href="{% url 'agri_app:home' %}">ãƒ›ãƒ¼ãƒ </a>
                <a class="nav-link" href="{% url 'agri_app:s3_file_list' %}">å†™çœŸä¸€è¦§</a>
              {% endif %}
            {% else %}
              <a class="nav-link" href="{% url 'agri_app:user_login' %}">ãƒ­ã‚°ã‚¤ãƒ³</a>
            {% endif %}
          </div>
          
          {% if user.is_authenticated %}
          <div class="nav-right">
            <div class="profile-dropdown">
              <button class="profile-toggle" onclick="toggleProfileMenu()">
                <span class="profile-avatar">{{ user.first_name|default:user.username|first|upper }}</span>
                <span class="profile-name">{{ user.first_name|default:user.username }}</span>
                <span class="dropdown-arrow">â–¼</span>
              </button>
              <div class="profile-menu" id="profileMenu">
                <a href="{% url 'agri_app:profile' %}" class="profile-menu-item {% if request.resolver_match.url_name == 'profile' %}active{% endif %}">
                  <span class="menu-icon">ğŸ‘¤</span>
                  ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
                </a>
                <a href="{% url 'agri_app:profile_edit' %}" class="profile-menu-item {% if request.resolver_match.url_name == 'profile_edit' %}active{% endif %}">
                  <span class="menu-icon">âœï¸</span>
                  ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†
                </a>
                <a href="{% url 'agri_app:password_change' %}" class="profile-menu-item {% if request.resolver_match.url_name == 'password_change' %}active{% endif %}">
                  <span class="menu-icon">ğŸ”</span>
                  ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´
                </a>
                {% if user.is_authenticated and user.is_staff %}
                <div class="profile-menu-divider"></div>
                <a href="{% url 'agri_app:user_list' %}" class="profile-menu-item {% if request.resolver_match.url_name in 'user_list,user_create,user_detail,user_edit,user_delete' %}active{% endif %}">
                  <span class="menu-icon">ğŸ‘¥</span>
                  ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†
                </a>
                <a href="{% url 'agri_app:group_list' %}" class="profile-menu-item {% if request.resolver_match.url_name in 'group_list,group_create,group_detail,group_edit,group_delete,group_members' %}active{% endif %}">
                  <span class="menu-icon">ğŸ·ï¸</span>
                  ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†
                </a>
                {% endif %}
                
                {% if user.is_authenticated and user.is_superuser %}
                <a href="{% url 'agri_app:style_settings' %}" class="profile-menu-item {% if request.resolver_match.url_name == 'style_settings' %}active{% endif %}">
                  <span class="menu-icon">ğŸ¨</span>
                  ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š
                </a>
                {% endif %}
                <div class="profile-menu-divider"></div>
                <a href="{% url 'agri_app:user_logout' %}" class="profile-menu-item">
                  <span class="menu-icon">ğŸšª</span>
                  ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                </a>
              </div>
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </nav>
    
    <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º -->
    {% if messages %}
    <div class="messages-container">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
          {{ message }}
        </div>
      {% endfor %}
    </div>
    {% endif %}
    
    <div class="container">
      {% block content %}{% endblock %}
    </div>

    <script>
    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢æ©Ÿèƒ½
    function clearCache() {
        if ('caches' in window) {
            caches.keys().then(function(names) {
                for (let name of names) {
                    caches.delete(name);
                }
            });
        }
    }
    
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
    window.addEventListener('load', function() {
        clearCache();
    });
    
    function toggleProfileMenu() {
        const menu = document.getElementById('profileMenu');
        const arrow = document.querySelector('.dropdown-arrow');
        
        menu.classList.toggle('show');
        
        // çŸ¢å°ã®å›è»¢
        if (menu.classList.contains('show')) {
            arrow.style.transform = 'rotate(180deg)';
        } else {
            arrow.style.transform = 'rotate(0deg)';
        }
    }

    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰é–‰ã˜ã‚‹
    document.addEventListener('click', function(event) {
        const dropdown = document.querySelector('.profile-dropdown');
        const menu = document.getElementById('profileMenu');
        const arrow = document.querySelector('.dropdown-arrow');
        
        if (!dropdown.contains(event.target)) {
            menu.classList.remove('show');
            arrow.style.transform = 'rotate(0deg)';
        }
    });

    // ESCã‚­ãƒ¼ã§ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            const menu = document.getElementById('profileMenu');
            const arrow = document.querySelector('.dropdown-arrow');
            
            menu.classList.remove('show');
            arrow.style.transform = 'rotate(0deg)';
        }
    });
    </script>
  </body>
</html>
